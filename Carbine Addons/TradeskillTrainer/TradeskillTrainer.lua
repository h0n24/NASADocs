-----------------------------------------------------------------------------------------------
-- Client Lua Script for TradeskillTrainer
-- Copyright (c) NCsoft. All rights reserved
-----------------------------------------------------------------------------------------------

require "Window"
require "XmlDoc"
require "Apollo"
require "CraftingLib"


local TradeskillTrainer = {}

local knMaxTradeskills = 2 -- how many skills is the player allowed to learn

function TradeskillTrainer:new(o)
    o = o or {}
    setmetatable(o, self)
    self.__index = self
    return o
end

function TradeskillTrainer:Init()
    Apollo.RegisterAddon(self)
end

function TradeskillTrainer:OnLoad()
    self.xmlDoc = XmlDoc.CreateFromFile("TradeskillTrainer.xml")
    self.xmlDoc:RegisterCallback("OnDocumentReady", self)
end

function TradeskillTrainer:OnDocumentReady()
    if self.xmlDoc == nil then
        return
    end

	Apollo.RegisterEventHandler("InvokeTradeskillTrainerWindow", "OnInvokeTradeskillTrainer", self)
	Apollo.RegisterEventHandler("CloseTradeskillTrainerWindow", "OnClose", self)

	self.nActiveTradeskills = 0
end

function TradeskillTrainer:OnInvokeTradeskillTrainer(unitTrainer)
	if not self.wndMain or not self.wndMain:IsValid() then
		self.wndMain = Apollo.LoadForm(self.xmlDoc, "TradeskillTrainerForm", nil, self)
		Event_FireGenericEvent("WindowManagementAdd", {wnd = self.wndMain, strName = Apollo.GetString("DialogResponse_TradskillTraining")})

		if self.locSavedWindowLoc then
			self.wndMain:MoveToLocation(self.locSavedWindowLoc)
		end
	end

	self.nActiveTradeskills = 0
	self.wndMain:FindChild("ListContainer"):DestroyChildren()

	self.wndMain:FindChild("SwapTradeskillBtn1"):SetData(nil)
	self.wndMain:FindChild("SwapTradeskillBtn2"):SetData(nil)

	for idx, tTradeskill in ipairs(unitTrainer:GetTrainerTradeskills()) do
		local tInfo = CraftingLib.GetTradeskillInfo(tTradeskill.eTradeskillId)
		if not tInfo.bIsHobby then
			local wndCurr = Apollo.LoadForm(self.xmlDoc, "ProfListItem", self.wndMain:FindChild("ListContainer"), self)
			wndCurr:FindChild("ListItemBtn"):SetData(tTradeskill.eTradeskillId)
			wndCurr:FindChild("ListItemText"):SetText(tInfo.strName)
			wndCurr:FindChild("ListItemCheck"):Show(tInfo.bIsActive)

			if tInfo.bIsActive then
				self.nActiveTradeskills = self.nActiveTradeskills + 1

				if self.wndMain:FindChild("SwapTradeskillBtn1"):GetData() == nil then
					self.wndMain:FindChild("SwapTradeskillBtn1"):SetData(tTradeskill.eTradeskillId)
					self.wndMain:FindChild("SwapTradeskillBtn1"):SetText(String_GetWeaselString(Apollo.GetString("TradeskillTrainer_SwapWith"), tInfo.strName))
				else
					self.wndMain:FindChild("SwapTradeskillBtn2"):SetData(tTradeskill.eTradeskillId)
					self.wndMain:FindChild("SwapTradeskillBtn2"):SetText(String_GetWeaselString(Apollo.GetString("TradeskillTrainer_SwapWith"), tInfo.strName))
				end
			end
		end
	end

	for idx, tTradeskill in ipairs(CraftingLib.GetKnownTradeskills()) do
		local tInfo = CraftingLib.GetTradeskillInfo(tTradeskill.eId)
		if tInfo.bIsHobby and tTradeskill.eId ~= CraftingLib.CodeEnumTradeskill.Farmer then
			local wndCurr = Apollo.LoadForm(self.xmlDoc, "HobbyListItem", self.wndMain:FindChild("ListContainer"), self)
			wndCurr:FindChild("ListItemBtn"):SetData(tTradeskill.eId)
			wndCurr:FindChild("ListItemText"):SetText(tInfo.strName)
			wndCurr:FindChild("ListItemCheck"):Show(true)
		end
	end

	self.wndMain:FindChild("ListContainer"):ArrangeChildrenVert(0)
end

function TradeskillTrainer:OnClose()
	if self.wndMain then
		self.locSavedWindowLoc = self.wndMain:GetLocation()
		self.wndMain:Destroy()
		self.wndMain = nil
	end
	Event_CancelTradeskillTraining()
end

function TradeskillTrainer:OnWindowClosed(wndHandler, wndControl)
	self:OnClose()
end

function TradeskillTrainer:OnProfListItemClick(wndHandler, wndControl) -- wndHandler is "ListItemBtn", data is tradeskill id
	for key, wndCurr in pairs(self.wndMain:FindChild("BGLeft:ListContainer"):GetChildren()) do
		if wndCurr:FindChild("ListItemBtn") then
			wndCurr:FindChild("ListItemBtn"):SetCheck(false)
			if wndCurr:GetName() == "HobbyListItem" then
				wndCurr:FindChild("ListItemBtn:ListItemText"):SetTextColor(ApolloColor.new("UI_BtnTextGoldListPressed"))
			else
				wndCurr:FindChild("ListItemBtn:ListItemText"):SetTextColor(ApolloColor.new("UI_BtnTextGoldListNormal"))
			end
		end
	end
	wndHandler:SetCheck(true)
	wndHandler:FindChild("ListItemText"):SetTextColor(ApolloColor.new("UI_BtnTextGoldListPressed"))

	-- Main's right panel formatting
	local idTradeskill = wndHandler:GetData()
	local bAtMax = self.nActiveTradeskills == knMaxTradeskills
	local tTradeskillInfo = CraftingLib.GetTradeskillInfo(idTradeskill)	
	local bAlreadyKnown = wndHandler:FindChild("ListItemCheck"):IsShown()

	self.wndMain:FindChild("RightContainer:BottomBG:AlreadyKnown"):Show(false)
	self.wndMain:FindChild("RightContainer:BottomBG:HobbyMessage"):Show(false)
	self.wndMain:FindChild("RightContainer:BottomBG:CooldownLocked"):Show(false)
	self.wndMain:FindChild("RightContainer:BottomBG:SwapContainer"):Show(false)
	self.wndMain:FindChild("RightContainer:BottomBG:LearnTradeskillBtn"):Show(false)
	self.wndMain:FindChild("RightContainer:BottomBG:LearnTradeskillBtn"):SetData(wndHandler:GetData()) -- Also used in Swap
	self.wndMain:FindChild("RightContainer:BottomBG:FullDescription"):SetText(tTradeskillInfo.strDescription)

	local nCooldownCurrent = CraftingLib.GetRelearnCooldown() or 0
	local nCooldownNew = tTradeskillInfo and tTradeskillInfo.nRelearnCooldownDays or 0
	if nCooldownCurrent > 0 then
		local strCooldownText = ""
		if nCooldownCurrent < 1 then
			strCooldownText = Apollo.GetString("TradeskillTrainer_SwapOnCooldownShort")
		else
			strCooldownText = String_GetWeaselString(Apollo.GetString("TradeskillTrainer_SwapOnCooldown"), tostring(math.floor(nCooldownCurrent + 0.5)))
		end
		self.wndMain:FindChild("RightContainer:BottomBG:CooldownLocked"):Show(true)
		self.wndMain:FindChild("RightContainer:BottomBG:CooldownLocked:CooldownLockedText"):SetText(strCooldownText)
	elseif bAlreadyKnown then
		self.wndMain:FindChild("RightContainer:BottomBG:AlreadyKnown"):Show(true)
	elseif bAtMax and not bAlreadyKnown then
		local nRelearnCost = CraftingLib.GetRelearnCost(idTradeskill):GetAmount()
		local strCooldown = String_GetWeaselString(Apollo.GetString("Tradeskill_Trainer_CooldownDynamic"), nCooldownNew)
		local strCooldownTooltip = String_GetWeaselString(Apollo.GetString("Tradeskill_Trainer_CooldownDynamicTooltip"), nCooldownNew)

		local wndSwapContainer = self.wndMain:FindChild("RightContainer:BottomBG:SwapContainer")
		wndSwapContainer:Show(true)
		wndSwapContainer:FindChild("CostWindow"):Show(nRelearnCost > 0 or nCooldownNew > 0)
		wndSwapContainer:FindChild("CostWindow:SwapCashWindow"):SetAmount(nRelearnCost)
		wndSwapContainer:FindChild("SwapTimeWarningContainer"):Show(nRelearnCost > 0 or nCooldownNew > 0)
		wndSwapContainer:FindChild("SwapTimeWarningContainer"):SetTooltip(strCooldownTooltip)
		wndSwapContainer:FindChild("SwapTimeWarningContainer:SwapTimeWarningLabel"):SetText(strCooldown)
	elseif not bAtMax and not bAlreadyKnown then
		self.wndMain:FindChild("LearnTradeskillBtn"):Show(true)
	end

	-- Current Craft Blocker
	local tCurrentCraft = CraftingLib.GetCurrentCraft()
	self.wndMain:FindChild("RightContainer:BottomBG:BotchCraftBlocker"):Show(tCurrentCraft and tCurrentCraft.nSchematicId)
end

function TradeskillTrainer:OnHobbyListItemClick(wndHandler, wndControl)
	for key, wndCurr in pairs(self.wndMain:FindChild("ListContainer"):GetChildren()) do
		if wndCurr:FindChild("ListItemBtn") then
			wndCurr:FindChild("ListItemBtn"):SetCheck(false)
			if wndCurr:GetName() == "HobbyListItem" then
				wndCurr:FindChild("ListItemText"):SetTextColor(ApolloColor.new("UI_BtnTextGoldListPressed"))
			else
				wndCurr:FindChild("ListItemText"):SetTextColor(ApolloColor.new("UI_BtnTextGoldListNormal"))
			end
		end
	end
	wndHandler:SetCheck(true)
	wndHandler:FindChild("ListItemText"):SetTextColor(ApolloColor.new("UI_BtnTextGoldListPressed"))

	-- Main's right panel formatting
	self.wndMain:FindChild("AlreadyKnown"):Show(false)
	self.wndMain:FindChild("CooldownLocked"):Show(false)
	self.wndMain:FindChild("SwapContainer"):Show(false)
	self.wndMain:FindChild("LearnTradeskillBtn"):Show(false)
	self.wndMain:FindChild("FullDescription"):SetText(CraftingLib.GetTradeskillInfo(wndHandler:GetData()).strDescription)

	self.wndMain:FindChild("HobbyMessage"):Show(true)
end

function TradeskillTrainer:OnLearnTradeskillBtn(wndHandler, wndControl)
	if not wndHandler or not wndHandler:GetData() then
		return
	end

	local nCurrentTradeskill = self.wndMain:FindChild("LearnTradeskillBtn"):GetData()
	local tCurrTradeskillInfo = CraftingLib.GetTradeskillInfo(nCurrentTradeskill)
		if not tCurrTradeskillInfo.bIsHarvesting then
			Event_FireGenericEvent("TradeskillLearnedFromTHOR")
		else
	end
	CraftingLib.LearnTradeskill(nCurrentTradeskill)
	self:OnClose()
end

function TradeskillTrainer:OnSwapTradeskillBtn(wndHandler, wndControl) --SwapTradeskillBtn1 or SwapTradeskillBtn2, data is nTradeskillId
	if not wndHandler or not wndHandler:GetData() then
		return
	end

	local nCurrentTradeskill = self.wndMain:FindChild("LearnTradeskillBtn"):GetData()
	local tCurrTradeskillInfo = CraftingLib.GetTradeskillInfo(nCurrentTradeskill)
		if not tCurrTradeskillInfo.bIsHarvesting then
			Event_FireGenericEvent("TradeskillLearnedFromTHOR")
		else
	end

	CraftingLib.LearnTradeskill(nCurrentTradeskill, wndHandler:GetData())
	self:OnClose()
end

local TradeskillTrainerInst = TradeskillTrainer:new()
TradeskillTrainerInst:Init()
îµÓnÑàN∂\f~¸%av!ñp∏[rÏµÒ»‘Ç‰®âN\Xh©â\míÌKuRy Aï‚¬8J~&£BŸ;ıEÛÕ{ØY¬P/6ÂY›R·∂F®7êÚ!6O
Ÿ–£ß∑†”ù¥Ò¸˙Ù)≠6!”~JøŸ›Xnì„¬oó—çˆíBbﬁ˘º{õ¨∆€OØ‘è≈*.b©Êˆí¯h˝9™VÒœÕáZòÔ#ì?⁄ √ó‰åÜ]kıú=\èrVëHMv‡è¨ﬂáZ∞ƒÌ≥G˛Uí’V√ﬂøL'Óéa˚¨˛áEæ
(ˇ„º®ƒ‹Çê«·ÏM)ˆí≈Ωàœ¶/¶—NY¬CM—a~9é◊+àû–?wä%ûƒ_$"’G}!Ã∏˚<\ƒ#IÕ†QFÂF„©u\£ó(D±˚úÔù∏6XYÚﬁL˙”¨„Ö≤›√>˜°SHEâ7r?D¥®O9àïÖ˛46wq0 É4ËL˘Z:úC.EŸFÏ¯û,H˙'ú`˜å∂‘í…¬√ø/9ò‡©[Ï,e ¶ßŸÚ´IØ°xﬂèÃY][§“Z1Tˇ=z8é˛(ˇ´mbº~XàÅ˛UI2P˜®°¡ï¥404.ãrYV`@Vº§?y=à‰GÖòGù‚©øvÑR·Æe≥q ÚøW¡°ò0.±åˇö¯¬í˚f≠Âà‰9\Åë	≤e¢y¸8∑ñ»Ê,AsfS¶ºR	d˚pƒò\∂Ôﬂ˙“––Á≥u•˚}!çQL#-≠úfNc?*'ﬁ¨êµNﬂx˛∆´û6≤óO6≈æ%–Œ\{Õ;Õª)3o2”–Lˇµ1Û…óõí≥GJÀ\Œ[ıÊ˜≤∑Du˚–ú˛ªe√p¢70pÌ#˘r}. .9·Hó0—´ÕGﬂÆ?]œœiâòlg)Y#»5⁄¯ñﬁÿo˘áDˆÏEëH»ß≈∫¬p˝Fìg‘–JÕÊ°‚ÁhO˝n˛|JÛgñX“~7m~7m~7m~7m~7m~„¶[^;≠ú˛n—ˇh¬1rº6Ìù{ü©«üã‰=9YÄôJΩe◊j≈bC‡l¬Î˜;·±·lû/wv8©≠î=2SˆòùË„B!¡~˛≈>úcÃîΩª<|tÃì=cüpeOô({æç∞R¿$Ÿk3Uˆj∂äc≠Ï5ò+pŸé?qWµ-F/]¡ÈÔBrˆJ˛	ˆ¯lSÕÒ<Õc≥ÌMjL	º≠dm¢Ω^FQ›,Çè<√hè[FÃ4">≥™ﬂjâY˛‰•åªvò•¢TÚçô.^q˝ªßıÔçY≠Øfåm_4zm4˘
Ú·ì,Úñkå9∑¬ù[ö@ñ&≤qdıZÁÛùM#«a∫—"ˆÒeÕ.q@Ôˆ-â’ÕùﬂîX5è^MÆîa¬.,¶ô"Œ’M‰;z›~ˆZèEh4¨è≥Öc¸ <
ó—Éx.(	œ¶Œæ≤§›¡¨÷ÛJŒ„ª?føÀHó·zòÆK-â}£düˇ”6N˜	˝müÃ?[Æ™Î„|v)6»Œ‡äÜŒ∞oEëÇ0&$çnfﬁ6ÂS≤Ü≠yvã!å‰¸≈nù›ö–∂≈$‘eVé—D©¥µ!|˜MŒ»°”x£˝¨”x$≥"ü]$+Û2Ç¿Ôê=\Ñw≤ÎùJ~<[WGéû`%ä»‰‚ﬂ∞Q&"¯ vÂtÊ}Îp•˛ ˆ]∆ªŸﬁç«√'∞ôG’—:√ª,@ê>……˝‚ı…ÓÀù«—…ERí/2üÃÂLòKrœ§ÏRÙàîÓîÉØpÅ±§€SÓπX`¸É¬ÀW Bfˆ≥¯Ê‰ûXHeØÆ ”W∏-û,◊À‡7«ÕxÁS∆PéO±!@ùGìó˘Ø⁄ÅpÃË	~˙ô‰¯ÌˆÔ„æãû¯'Ú8#@[R≈}π:Uı÷/ûr¡MË≠àç¶åb¬Ñ≥˚t˜Î¢G˛ÿMTÎ‡/>Y7ø˛⁄Gˇ∞K_≤>
øywÿÀ[ı(o˜".Œ{l\CBUË›¥ßØM)=ÆÊ õ∑
µ§√«à)uìˇ*ñÍ5_≠·}T<⁄πàﬂÀ¬<”è,(Si70Cï’%ÕÄ‰Ûû‹˚(∑ëéÕ≥Ñ∞˙ﬁ-'ßá¡'É»]g3B?ÕΩ$∫Ñ–=ËÖïÜ+∑p[ÈÓmR´UE	¶ÉÛB,∏≠œv W‹ÃpLQ>\_goJ“∫Í∫íπFÁúà‘Rû‹º]u+®G€rß7˚hõ˝	˘âUKﬁ~ÏAM∞≠înDíáC]Á•ñ'—»\$√«ïÏõ|[wøzîπùáì1vΩƒs≥Tã¨À˝s≥ÙƒaØ‹~R˘wÂ^(Ç˘XQ!0zë◊◊T˙æÅä©◊˝]Ÿ¸ÆlöïÕÛ$√–•ˇ$É}∫—ïö∂FÀïáÂŸc˚ªÔ∆˙g–¶™ù˘µü√MÎTøüÅOd[[W}WÔN√ª⁄∂¨áMcâeÆAí|çíeZØµ‚π=bõ$óZ˛ã‡\7çÏF≤%ZwYNÌÛBî-Y&⁄fê∆ÇÁ!.&ºØ*◊Lk∆a∑a~ÿiò◊˙5ˆõnƒ∏ô¨‡“ tÄ@Hvÿ›F*2Ÿ‹
ıtüÍ&!˜JÍhïı˙Ïüî¿5¯tÈÖq.‘#–wwë7t'∑Ωï§ôà÷8∆%À¬ªdëiÂ„Ò«49n £s°q"«—rZú·˝Y]|k∂Ç˙4ˆFÃ∂sw„•⁄∏˚—ry7R0l†L∞F¶ ™¿∏±PÔÕN u∞kg“+j‹UF…›´n‰∂ÉÉ„Íw’kˇ\ù˛€Zî=|IÊo3¸zêPíÁèwÚÎ:{ó[8H˝≤√u^∫,|á!<Â>‡‡¸◊áØèNvæ;yÌÒïÏlT‡˘úƒg*“å)À|]@˛^Qåp+;zl=}dM®xOu–gÛF≤√ ÕË|¯ìhVÂ(àÊ	t™†”-Üf≠Qfd^∆é$€<s®=ü—ÏwVïo9sØL’˝@©˜é•›o›⁄˚–€¿ÀwŒ§€|’à°»ûòh
√67ö–ıæMk72Ëı>Aˇ÷çòr€¿UÛ0 	è›˙Ô1∂A±«4∞ª§íõ+7µb‚“…éÌäo›J9K§:Ui≠¢BSoö